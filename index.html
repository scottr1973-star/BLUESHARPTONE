<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Blues Harp Tone — Full Build (Anti-Gate, Presets, 3-Band EQ)</title>

<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>

<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme:{
    extend:{
      fontFamily:{ sans:['Inter','system-ui','sans-serif'], display:['Orbitron','Inter','system-ui','sans-serif'] },
      colors:{ accent:{DEFAULT:'#7dd3fc',deep:'#38bdf8'} },
      boxShadow:{ panel:'0 14px 32px rgba(0,0,0,.45)' }
    }
  }
}
</script>

<style>
:root{ --slider-h:28px; --slider-track:9px; --thumb:20px; }
.hslider{
  -webkit-appearance:none;appearance:none;width:100%;height:var(--slider-h);background:transparent;display:block;cursor:pointer;touch-action:pan-y;
}
.hslider::-webkit-slider-runnable-track,
.hslider::-moz-range-track{
  height:var(--slider-track);border-radius:9999px;
  background:linear-gradient(180deg,rgba(255,255,255,.14),rgba(0,0,0,.22)),linear-gradient(90deg,#2e4b70,#173354);
  box-shadow:inset 0 1px 0 rgba(255,255,255,.10), inset 0 -1px 0 rgba(0,0,0,.45);
}
.hslider::-webkit-slider-thumb,
.hslider::-moz-range-thumb{
  -webkit-appearance:none;appearance:none;width:var(--thumb);height:var(--thumb);border-radius:10px;
  background:radial-gradient(120% 120% at 30% 20%,#fff 0%,#eef6ff 55%,#e0f2fe 80%,#bae6fd 100%);
  border:1px solid #7dd3fc;
  box-shadow:0 3px 10px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.8), inset 0 -1px 0 rgba(0,0,0,.35);
  margin-top:calc((var(--slider-track)-var(--thumb))/2);
}
.toggle-pill{position:relative;display:inline-flex;height:28px;width:56px;align-items:center;border-radius:9999px;background:rgba(2,6,23,.85);box-shadow:inset 0 0 0 1px rgba(100,116,139,.6);}
.toggle-dot{position:absolute;left:4px;top:4px;height:20px;width:20px;border-radius:9999px;background:#f1f5f9;box-shadow:inset 0 1px 0 rgba(255,255,255,.75), inset 0 -1px 0 rgba(0,0,0,.35), 0 2px 6px rgba(0,0,0,.35);transition:transform .2s;}
.toggle-on{background:#38bdf8;box-shadow:inset 0 0 0 1px rgba(56,189,248,.7);} .dot-on{transform:translateX(28px);}
canvas{display:block;width:100%;height:100%;}
#vu{height:22px;}
#toast{position:fixed;top:-100px;left:50%;transform:translateX(-50%);background:#ef4444;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 12px 30px rgba(0,0,0,.3);font-weight:700;z-index:1000;transition:top .45s;}
.section{box-shadow: inset 0 1px 0 rgba(255,255,255,.08), inset 0 -1px 0 rgba(0,0,0,.4);}
</style>
</head>
<body class="min-h-screen bg-gradient-to-br from-[#0b1b2e] via-[#134b7a] to-[#0a1730] text-slate-100 antialiased">
<div id="toast">Mic permission needed. Click Start and allow.</div>

<main class="mx-auto p-3 sm:p-4">
<section class="mx-auto w-full max-w-[360px] sm:max-w-[560px] md:max-w-[980px] rounded-3xl border border-slate-700 shadow-panel overflow-hidden bg-[radial-gradient(140%_120%_at_0%_0%,#2a6aa0_0%,rgba(24,42,76,0.95)_45%,#18406f_100%)]">
  <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 border-b border-slate-700/60 px-4 pt-4 pb-3">
    <div>
      <h1 class="font-display text-lg sm:text-xl tracking-wide drop-shadow-[0_0_12px_rgba(125,211,252,0.5)]">BLUES HARP — CHICAGO RIG</h1>
      <p class="text-[12px] text-slate-300">Full build • anti-gate • presets • 3-band EQ • slapback.</p>
    </div>
    <div class="flex items-center gap-3">
      <button id="btnStart" class="px-3 py-2 rounded-lg text-[12px] font-semibold bg-gradient-to-b from-accent to-accent-deep text-slate-900 ring-1 ring-white/30 hover:brightness-95 active:brightness-90">Start Audio</button>
      <div class="flex items-center gap-2 text-[11px]"><span id="led" class="inline-block h-3 w-3 rounded-full bg-slate-600 ring-2 ring-slate-900"></span><span id="status">Off</span></div>
    </div>
  </header>

  <div class="px-4 pt-2 space-y-3">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
      <div class="flex items-center gap-2">
        <label class="text-[12px]">Input:</label>
        <select id="devSel" class="min-w-[200px] max-w-full flex-1 px-2 py-1 text-[12px] bg-slate-900/70 ring-1 ring-slate-600 rounded-md"></select>
        <button id="devRef" class="px-2 py-1 text-[11px] rounded-md bg-slate-900/60 ring-1 ring-slate-600 hover:bg-slate-900">Refresh</button>
      </div>
      <div class="flex items-center gap-3 text-[11px] text-slate-200/90"><span id="sr">SR: —</span><span>•</span><span id="lat">Latency: —</span></div>
    </div>

    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-2"><span class="text-[11px]">Anti-Gate</span><button id="antiGateBtn" class="toggle-pill"><span class="toggle-dot"></span></button></div>
        <div class="flex items-center gap-2 text-[11px]"><span class="text-slate-200/80">CLIP</span><div id="clipLED" class="h-3 w-3 rounded-full bg-slate-600 ring-2 ring-slate-900"></div></div>
      </div>
      <div class="text-[11px]">Limiter GR: <span id="gr">0.0</span> dB</div>
    </div>

    <div id="vu" class="rounded-xl ring-1 ring-slate-700 bg-[#0a1930]/80 overflow-hidden"><canvas id="vuCanvas"></canvas></div>

    <!-- Mic & Preamp -->
    <div class="section rounded-2xl border border-slate-700 bg-gradient-to-b from-[#2b6ea9] to-[#1c4f7f] p-3">
      <div class="grid grid-cols-12 items-center gap-2">
        <div class="col-span-12 lg:col-span-6">
          <div class="text-[12px] uppercase tracking-wider mb-1">Mic Model</div>
          <div class="grid grid-cols-12 items-center gap-2">
            <div class="col-span-4 text-[11px]">Type</div>
            <div class="col-span-8">
              <select id="micModel" class="w-full px-2 py-1 text-[12px] bg-slate-900/70 ring-1 ring-slate-600 rounded-md">
                <option value="bullet">Bullet (Green Bullet)</option>
                <option value="sm57">SM57</option>
                <option value="cond">Condenser</option>
              </select>
            </div>
            <div class="col-span-4 text-[11px] mt-2">Proximity</div>
            <div class="col-span-6 mt-2"><input id="prox" class="hslider" type="range" min="0" max="12" step="0.5" value="4"/></div>
            <div class="col-span-2 text-right text-[11px] mt-2"><span id="proxV">+4</span> dB</div>
            <div class="col-span-4 text-[11px] mt-2">Input Pad</div>
            <div class="col-span-6 mt-2"><input id="pad" class="hslider" type="range" min="-18" max="0" step="1" value="0"/></div>
            <div class="col-span-2 text-right text-[11px] mt-2"><span id="padV">0</span> dB</div>
          </div>
        </div>

        <div class="col-span-12 lg:col-span-6">
          <div class="text-[12px] uppercase tracking-wider mb-1">Preamp / Drive</div>
          <div class="grid grid-cols-12 items-center gap-2">
            <div class="col-span-3 text-[11px]">Drive</div>
            <div class="col-span-7"><input id="drive" class="hslider" type="range" min="0" max="100" step="1" value="32"/></div>
            <div class="col-span-2 text-right text-[11px]"><span id="driveV">32</span></div>

            <div class="col-span-3 text-[11px] mt-2">Tone (Cut)</div>
            <div class="col-span-7 mt-2"><input id="toneCut" class="hslider" type="range" min="1000" max="8000" step="50" value="4200"/></div>
            <div class="col-span-2 text-right text-[11px] mt-2"><span id="toneCutV">4200</span> Hz</div>

            <div class="col-span-3 text-[11px] mt-2">Level</div>
            <div class="col-span-7 mt-2"><input id="level" class="hslider" type="range" min="-12" max="12" step="0.5" value="0"/></div>
            <div class="col-span-2 text-right text-[11px] mt-2"><span id="levelV">0</span> dB</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 3-Band EQ -->
    <div class="section rounded-2xl border border-slate-700 bg-gradient-to-b from-[#2b6ea9] to-[#1c4f7f] p-3">
      <div class="text-[12px] uppercase tracking-wider mb-1">3-Band EQ</div>
      <div class="grid grid-cols-12 items-center gap-2">
        <div class="col-span-3 text-[11px]">Low</div>
        <div class="col-span-7"><input id="eqL" class="hslider" type="range" min="-12" max="12" step="0.5" value="2"/></div>
        <div class="col-span-2 text-right text-[11px]"><span id="eqLV">+2</span> dB</div>

        <div class="col-span-3 text-[11px] mt-2">Mid</div>
        <div class="col-span-7 mt-2"><input id="eqM" class="hslider" type="range" min="-12" max="12" step="0.5" value="-2"/></div>
        <div class="col-span-2 text-right text-[11px] mt-2"><span id="eqMV">-2</span> dB</div>

        <div class="col-span-3 text-[11px] mt-2">High</div>
        <div class="col-span-7 mt-2"><input id="eqH" class="hslider" type="range" min="-12" max="12" step="0.5" value="-1"/></div>
        <div class="col-span-2 text-right text-[11px] mt-2"><span id="eqHV">-1</span> dB</div>
      </div>
    </div>

    <!-- FX -->
    <div class="section rounded-2xl border border-slate-700 bg-gradient-to-b from-[#2b6ea9] to-[#1c4f7f] p-3">
      <div class="grid grid-cols-12 items-center gap-2">
        <div class="col-span-12 md:col-span-7">
          <div class="text-[12px] uppercase tracking-wider mb-1">Slapback & Reverb</div>
          <div class="grid grid-cols-12 items-center gap-2">
            <div class="col-span-3 text-[11px]">Delay</div>
            <div class="col-span-7"><input id="dlyTime" class="hslider" type="range" min="0.05" max="0.45" step="0.005" value="0.12"/></div>
            <div class="col-span-2 text-right text-[11px]"><span id="dlyTimeV">0.12</span>s</div>

            <div class="col-span-3 text-[11px] mt-2">Feedback</div>
            <div class="col-span-7 mt-2"><input id="dlyFB" class="hslider" type="range" min="0" max="0.85" step="0.01" value="0.25"/></div>
            <div class="col-span-2 text-right text-[11px] mt-2"><span id="dlyFBV">0.25</span></div>

            <div class="col-span-3 text-[11px] mt-2">Mix</div>
            <div class="col-span-7 mt-2"><input id="dlyMix" class="hslider" type="range" min="0" max="1" step="0.01" value="0.22"/></div>
            <div class="col-span-2 text-right text-[11px] mt-2"><span id="dlyMixV">0.22</span></div>

            <div class="col-span-3 text-[11px] mt-2">Reverb</div>
            <div class="col-span-7 mt-2"><input id="rvbMix" class="hslider" type="range" min="0" max="1" step="0.01" value="0.18"/></div>
            <div class="col-span-2 text-right text-[11px] mt-2"><span id="rvbMixV">0.18</span></div>
          </div>
        </div>

        <div class="col-span-12 md:col-span-5">
          <div class="text-[12px] uppercase tracking-wider mb-1">Dynamics / Gate</div>
          <div class="grid grid-cols-12 items-center gap-2">
            <div class="col-span-4 text-[11px]">Comp Thresh</div>
            <div class="col-span-6"><input id="cpTh" class="hslider" type="range" min="-50" max="0" step="1" value="-22"/></div>
            <div class="col-span-2 text-right text-[11px]"><span id="cpThV">-22</span> dB</div>

            <div class="col-span-4 text-[11px] mt-2">Ratio</div>
            <div class="col-span-6 mt-2"><input id="cpRa" class="hslider" type="range" min="1" max="20" step="0.5" value="2.5"/></div>
            <div class="col-span-2 text-right text-[11px] mt-2"><span id="cpRaV">2.5</span>:1</div>

            <div class="col-span-4 text-[11px] mt-2">Gate Th</div>
            <div class="col-span-6 mt-2"><input id="ngTh" class="hslider" type="range" min="-80" max="-20" step="1" value="-70"/></div>
            <div class="col-span-2 text-right text-[11px] mt-2"><span id="ngThV">-70</span> dB</div>

            <div class="col-span-4 text-[11px] mt-2">Release</div>
            <div class="col-span-6 mt-2"><input id="ngRel" class="hslider" type="range" min="0.02" max="0.5" step="0.01" value="0.2"/></div>
            <div class="col-span-2 text-right text-[11px] mt-2"><span id="ngRelV">0.20</span>s</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Output & Presets -->
    <div class="section rounded-2xl border border-slate-700 bg-gradient-to-b from-[#2b6ea9] to-[#1c4f7f] p-3">
      <div class="grid grid-cols-12 items-center gap-2">
        <div class="col-span-12 md:col-span-5">
          <div class="text-[12px] uppercase tracking-wider mb-1">Output</div>
          <div class="grid grid-cols-12 items-center gap-2">
            <div class="col-span-3 text-[11px]">Level</div>
            <div class="col-span-7"><input id="out" class="hslider" type="range" min="0" max="1.2" step="0.01" value="1.0"/></div>
            <div class="col-span-2 text-right text-[11px]"><span id="outV">1.00</span></div>
          </div>
        </div>
        <div class="col-span-12 md:col-span-7">
          <div class="text-[12px] uppercase tracking-wider mb-1">Presets & Slots</div>
          <div class="grid grid-cols-12 gap-2 items-center">
            <div class="col-span-12">
              <div class="flex items-center gap-2">
                <select id="presetSel" class="w-full px-2 py-1 text-[12px] bg-slate-900/70 ring-1 ring-slate-600 rounded-md">
                  <option value="">— Built-in Presets —</option>
                  <option>Chicago Crunch</option>
                  <option>Little Walter</option>
                  <option>Clean Amp</option>
                  <option>Slapback King</option>
                  <option>Dark Room</option>
                  <option>Bright Cut</option>
                </select>
                <button id="presetApply" class="px-2 py-1 text-[11px] rounded-md bg-slate-900/60 ring-1 ring-slate-600 hover:bg-slate-900">Load</button>
              </div>
            </div>

            <div class="col-span-12">
              <div class="flex flex-col sm:flex-row gap-2">
                <select id="slotSel" class="flex-1 px-2 py-1 text-[12px] bg-slate-900/70 ring-1 ring-slate-600 rounded-md"></select>
                <div class="flex gap-2">
                  <button id="slotLoad"  class="px-2 py-1 text-[11px] rounded-md bg-slate-900/60 ring-1 ring-slate-600">Load</button>
                  <button id="slotSave"  class="px-2 py-1 text-[11px] rounded-md bg-accent/20 ring-1 ring-accent/40 hover:bg-accent/30">Save</button>
                  <button id="slotRename"class="px-2 py-1 text-[11px] rounded-md bg-slate-900/60 ring-1 ring-slate-600">Rename</button>
                  <button id="slotExport"class="px-2 py-1 text-[11px] rounded-md bg-slate-900/60 ring-1 ring-slate-600">Export</button>
                  <button id="slotImport"class="px-2 py-1 text-[11px] rounded-md bg-slate-900/60 ring-1 ring-slate-600">Import</button>
                  <input id="importFile" type="file" accept="application/json" class="hidden"/>
                </div>
              </div>
              <p class="mt-1 text-[11px] text-slate-300/80">10 user slots stored locally.</p>
              <div id="slotGrid" class="mt-2 grid grid-cols-2 sm:grid-cols-5 gap-2"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</section>
</main>

<script>
const $=id=>document.getElementById(id);
const dBToLin=d=>Math.pow(10,d/20), linToDb=x=>x>0?20*Math.log10(x):-Infinity;
function setToggle(btn,on){ btn.classList.toggle('toggle-on',on); btn.querySelector('.toggle-dot')?.classList.toggle('dot-on',on); }
function isOn(btn){ return btn.classList.contains('toggle-on'); }
function toast(m){ const b=$('toast'); b.textContent=m; b.style.top='20px'; setTimeout(()=>b.style.top='-100px', 2500); }
function clamp(v,min,max){ return Math.min(max, Math.max(min,v)); }

let ctx, stream, src, running=false, deviceId=null;
let pre, preAnalyser, gateGain, analyser, outGain, limiter, comp;
let micLS, micHS, proxShelf;
let shaper, toneLP, levelGain;
let eqL, eqM, eqH;
let dly, dlyFB, dlyWet, dlyDry, rvb, rvbWet, rvbDry;
let antiGateSrc=null, antiGateGain=null, silentSink=null;
let rafId=null;

const btnStart=$('btnStart'), led=$('led'), status=$('status'), devSel=$('devSel'), devRef=$('devRef');
const sr=$('sr'), lat=$('lat'), antiGateBtn=$('antiGateBtn'), clipLED=$('clipLED'), vuCanvas=$('vuCanvas');

const micModel=$('micModel'), prox=$('prox'), proxV=$('proxV'), pad=$('pad'), padV=$('padV');
const drive=$('drive'), driveV=$('driveV'), toneCut=$('toneCut'), toneCutV=$('toneCutV'), level=$('level'), levelV=$('levelV');
const eqLS=$('eqL'), eqLV=$('eqLV'), eqMS=$('eqM'), eqMV=$('eqMV'), eqHS=$('eqH'), eqHV=$('eqHV');
const dlyTime=$('dlyTime'), dlyTimeV=$('dlyTimeV'), dlyFBSl=$('dlyFB'), dlyFBV=$('dlyFBV'), dlyMix=$('dlyMix'), dlyMixV=$('dlyMixV');
const rvbMix=$('rvbMix'), rvbMixV=$('rvbMixV');
const cpTh=$('cpTh'), cpThV=$('cpThV'), cpRa=$('cpRa'), cpRaV=$('cpRaV'), ngTh=$('ngTh'), ngThV=$('ngThV'), ngRel=$('ngRel'), ngRelV=$('ngRelV');
const out=$('out'), outV=$('outV'), gr=$('gr');

const presetSel=$('presetSel'), presetApply=$('presetApply');
const slotSel=$('slotSel'), slotLoad=$('slotLoad'), slotSave=$('slotSave'), slotRename=$('slotRename'), slotExport=$('slotExport'), slotImport=$('slotImport'), importFile=$('importFile'), slotGrid=$('slotGrid');

btnStart.addEventListener('click', ()=>{ if(!running) start(); else stop(); });
devRef.addEventListener('click', populate);
devSel.addEventListener('change', ()=>{ deviceId=devSel.value||null; localStorage.setItem('harpPreferredDevice', deviceId||''); if(running){ stop(); start(); } });
antiGateBtn.addEventListener('click', ()=>{ setToggle(antiGateBtn, !isOn(antiGateBtn)); if(isOn(antiGateBtn)) startAntiGate(); else stopAntiGate(); });
navigator.mediaDevices?.addEventListener?.('devicechange', populate);

// UI binds
prox.addEventListener('input', ()=>{ proxV.textContent=(prox.value>0?'+':'')+prox.value; if(proxShelf) proxShelf.gain.value=+prox.value; });
pad.addEventListener('input',  ()=>{ padV.textContent=pad.value; if(pre) pre.gain.value = dBToLin(+pad.value); });
drive.addEventListener('input',()=>{ driveV.textContent=drive.value; if(shaper) shaper.curve = makeDriveCurve(+drive.value); });
toneCut.addEventListener('input',()=>{ toneCutV.textContent=toneCut.value; if(toneLP) toneLP.frequency.value=+toneCut.value; });
level.addEventListener('input', ()=>{ levelV.textContent=level.value; if(levelGain) levelGain.gain.value=dBToLin(+level.value); });
eqLS.addEventListener('input', ()=>{ eqLV.textContent=(eqLS.value>0?'+':'')+eqLS.value; if(eqL) eqL.gain.value=+eqLS.value; });
eqMS.addEventListener('input', ()=>{ eqMV.textContent=(eqMS.value>0?'+':'')+eqMS.value; if(eqM) eqM.gain.value=+eqMS.value; });
eqHS.addEventListener('input', ()=>{ eqHV.textContent=(eqHS.value>0?'+':'')+eqHS.value; if(eqH) eqH.gain.value=+eqHS.value; });

dlyTime.addEventListener('input', ()=>{ dlyTimeV.textContent=parseFloat(dlyTime.value).toFixed(2); if(dly) dly.delayTime.value=+dlyTime.value; });
dlyFBSl.addEventListener('input', ()=>{ dlyFBV.textContent=parseFloat(dlyFBSl.value).toFixed(2); if(dlyFB) dlyFB.gain.value=+dlyFBSl.value; });
dlyMix.addEventListener('input', ()=>{ dlyMixV.textContent=parseFloat(dlyMix.value).toFixed(2); if(dlyWet&&dlyDry){ dlyWet.gain.value=+dlyMix.value; dlyDry.gain.value=1-+dlyMix.value; } });
rvbMix.addEventListener('input', ()=>{ rvbMixV.textContent=parseFloat(rvbMix.value).toFixed(2); if(rvbWet&&rvbDry){ rvbWet.gain.value=+rvbMix.value; rvbDry.gain.value=1-+rvbMix.value; } });

cpTh.addEventListener('input', ()=>{ cpThV.textContent=cpTh.value; if(comp) comp.threshold.value=+cpTh.value; });
cpRa.addEventListener('input', ()=>{ cpRaV.textContent=cpRa.value; if(comp) comp.ratio.value=+cpRa.value; });
ngTh.addEventListener('input', ()=>{ ngThV.textContent=ngTh.value; });
ngRel.addEventListener('input', ()=>{ ngRelV.textContent=ngRel.value; });

out.addEventListener('input', ()=>{ outV.textContent=parseFloat(out.value).toFixed(2); if(outGain) outGain.gain.value=+out.value; });

micModel.addEventListener('change', ()=>applyMicModel(micModel.value));

async function start(){
  try{
    if(!ctx) ctx = new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'});
    sr.textContent='SR: '+ctx.sampleRate+' Hz';
    const l=(ctx.baseLatency||0)+(ctx.outputLatency||0); lat.textContent='Latency: '+Math.round(l*1000)+' ms';
    const constraints={
      audio:{
        deviceId: deviceId ? {exact: deviceId} : undefined,
        echoCancellation:false, noiseSuppression:false, autoGainControl:false,
        channelCount:1, sampleRate:48000,
        googEchoCancellation:false, googEchoCancellation2:false,
        googAutoGainControl:false, googAutoGainControl2:false,
        googNoiseSuppression:false, googHighpassFilter:false, googTypingNoiseDetection:false
      }
    };
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    const track=stream.getAudioTracks()[0]; try{ await track.applyConstraints({ echoCancellation:false, noiseSuppression:false, autoGainControl:false }); }catch{}
    if('contentHint' in track) track.contentHint='music';

    await populate();
    build(); wire(); sizeCanvas(); loop();

    silentSink = ctx.createGain(); silentSink.gain.value=0.0; analyser.connect(silentSink).connect(ctx.destination);
    if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) setToggle(antiGateBtn, true);
    if(isOn(antiGateBtn)) startAntiGate();

    running=true; btnStart.textContent='Stop Audio'; status.textContent='On'; led.style.backgroundColor='#22c55e';
    initSlotsUI(); restoreState();
  }catch(e){ console.error(e); toast('Mic permission needed. Click Start and allow.'); }
}
function stop(){
  cancelAnimationFrame(rafId); rafId=null;
  if(antiGateSrc){ try{antiGateSrc.stop();}catch{}; antiGateSrc.disconnect(); antiGateGain.disconnect(); antiGateSrc=null; antiGateGain=null; }
  if(stream) stream.getTracks().forEach(t=>t.stop());
  if(ctx && ctx.state!=='closed') ctx.close().then(()=>{ ctx=null; });
  running=false; btnStart.textContent='Start Audio'; status.textContent='Off'; led.style.backgroundColor='#64748b';
}
async function populate(){
  const devs=await navigator.mediaDevices.enumerateDevices().catch(()=>[]);
  const ins=devs.filter(d=>d.kind==='audioinput'); devSel.innerHTML='';
  ins.forEach((d,i)=>{ const o=document.createElement('option'); o.value=d.deviceId; o.textContent=d.label||('Input '+(i+1)); devSel.appendChild(o); });
  const pref=localStorage.getItem('harpPreferredDevice'); const t=deviceId||pref; if(t){ const f=[...devSel.options].find(o=>o.value===t); if(f) devSel.value=t; }
}

function build(){
  src = ctx.createMediaStreamSource(stream);
  pre = ctx.createGain(); pre.gain.value = dBToLin(+pad.value);
  preAnalyser = ctx.createAnalyser(); preAnalyser.fftSize=2048;
  gateGain = ctx.createGain(); gateGain.gain.value=1;

  // Mic coloration
  micLS = ctx.createBiquadFilter(); micLS.type='lowshelf'; micLS.frequency.value=160; micLS.gain.value=0;
  proxShelf = ctx.createBiquadFilter(); proxShelf.type='lowshelf'; proxShelf.frequency.value=220; proxShelf.gain.value=+prox.value;
  micHS = ctx.createBiquadFilter(); micHS.type='highshelf'; micHS.frequency.value=4500; micHS.gain.value=0;

  // Drive & tone
  shaper = ctx.createWaveShaper(); shaper.curve = makeDriveCurve(+drive.value); shaper.oversample='4x';
  toneLP = ctx.createBiquadFilter(); toneLP.type='lowpass'; toneLP.frequency.value=+toneCut.value;
  levelGain = ctx.createGain(); levelGain.gain.value = dBToLin(+level.value);

  // 3-band EQ
  eqL = ctx.createBiquadFilter(); eqL.type='lowshelf'; eqL.frequency.value=160; eqL.gain.value=+eqLS.value;
  eqM = ctx.createBiquadFilter(); eqM.type='peaking'; eqM.frequency.value=900; eqM.Q.value=0.9; eqM.gain.value=+eqMS.value;
  eqH = ctx.createBiquadFilter(); eqH.type='highshelf'; eqH.frequency.value=3500; eqH.gain.value=+eqHS.value;

  // FX
  dly = ctx.createDelay(1.0); dly.delayTime.value = +dlyTime.value;
  dlyFB = ctx.createGain(); dlyFB.gain.value = +dlyFBSl.value; dly.connect(dlyFB).connect(dly);
  dlyWet = ctx.createGain(); dlyWet.gain.value=+dlyMix.value; dlyDry = ctx.createGain(); dlyDry.gain.value=1-+dlyMix.value;
  rvb = ctx.createConvolver(); rvb.buffer = makeIR(ctx, 1.7);
  rvbWet = ctx.createGain(); rvbDry = ctx.createGain(); rvbWet.gain.value=+rvbMix.value; rvbDry.gain.value=1-+rvbMix.value;

  // Dynamics & out
  comp = ctx.createDynamicsCompressor(); comp.threshold.value=+cpTh.value; comp.ratio.value=+cpRa.value; comp.attack.value=0.012; comp.release.value=0.18;
  limiter = ctx.createDynamicsCompressor(); limiter.threshold.value=-1; limiter.knee.value=0; limiter.ratio.value=20; limiter.attack.value=0.002; limiter.release.value=0.08;
  outGain = ctx.createGain(); outGain.gain.value=+out.value;

  // Analyser
  analyser = ctx.createAnalyser(); analyser.fftSize=2048;

  applyMicModel(micModel.value);
}

function wire(){
  src.connect(pre); pre.connect(preAnalyser);
  pre.connect(micLS); micLS.connect(proxShelf); proxShelf.connect(micHS);
  micHS.connect(gateGain);

  gateGain.connect(shaper); shaper.connect(toneLP); toneLP.connect(levelGain);
  levelGain.connect(eqL); eqL.connect(eqM); eqM.connect(eqH);

  // Delay & Reverb (parallel)
  eqH.connect(dly); eqH.connect(dlyDry);
  dly.connect(dlyWet);
  const timeBus=ctx.createGain(); dlyWet.connect(timeBus); dlyDry.connect(timeBus);

  timeBus.connect(rvbDry); timeBus.connect(rvb); rvb.connect(rvbWet);

  const post = ctx.createGain(); rvbDry.connect(post); rvbWet.connect(post);

  post.connect(comp); comp.connect(limiter).connect(outGain).connect(analyser);
  outGain.connect(ctx.destination);
}

function applyMicModel(m){
  // reset to defaults
  micLS.gain.value=0; micHS.gain.value=0;
  if(m==='bullet'){ micLS.gain.value = 4; micHS.gain.value = -5; }
  else if(m==='sm57'){ micLS.gain.value = 2; micHS.gain.value = -2; }
  else if(m==='cond'){ micLS.gain.value = 0; micHS.gain.value = 0; }
}

function makeIR(ctx,len){ const sr=ctx.sampleRate,L=Math.floor(Math.max(0.4,Math.min(4,len))*sr); const ir=ctx.createBuffer(2,L,sr); for(let ch=0; ch<2; ch++){ const d=ir.getChannelData(ch); for(let i=0;i<L;i++){ const t=i/L; const decay=(1-t)**2; d[i]=(Math.random()*2-1)*decay*0.6; } } return ir; }
function makeDriveCurve(g){ const n=44100,a=new Float32Array(n); const k=Math.max(1,g); for(let i=0;i<n;i++){ const x=(i*2/n)-1; const y=(3+k)*x*0.6/(1+k*Math.abs(x)); a[i]=y; } return a; }

// Anti-gate noise injection
function startAntiGate(){ if(antiGateSrc) return; const len=ctx.sampleRate*2, buf=ctx.createBuffer(1,len,ctx.sampleRate); const d=buf.getChannelData(0); for(let i=0;i<len;i++){ d[i]=(Math.random()*2-1); } const s=ctx.createBufferSource(); s.buffer=buf; s.loop=true; const g=ctx.createGain(); g.gain.value=3.2e-5; s.connect(g).connect(pre); s.start(); antiGateSrc=s; antiGateGain=g; }
function stopAntiGate(){ if(!antiGateSrc) return; try{antiGateSrc.stop();}catch{}; antiGateSrc.disconnect(); antiGateGain.disconnect(); antiGateSrc=null; antiGateGain=null; }

// VU & simple soft gate
function sizeCanvas(){ const dpr=Math.max(1,Math.floor(window.devicePixelRatio||1)); const r=vuCanvas.getBoundingClientRect(); vuCanvas.width=Math.floor(r.width*dpr); vuCanvas.height=Math.floor(r.height*dpr); vuCanvas.getContext('2d').setTransform(dpr,0,0,dpr,0,0); }
window.addEventListener('resize', sizeCanvas); window.addEventListener('orientationchange', sizeCanvas);

function loop(){
  const td=new Uint8Array(analyser.fftSize), preTD=new Uint8Array(preAnalyser.fftSize), g=vuCanvas.getContext('2d');
  const step=()=>{
    preAnalyser.getByteTimeDomainData(preTD);
    let sum=0, peakIn=0; for(let i=0;i<preTD.length;i++){ const v=(preTD[i]-128)/128; sum+=v*v; peakIn=Math.max(peakIn,Math.abs(v)); }
    const rmsIn=Math.sqrt(sum/preTD.length), dbfs=linToDb(rmsIn), th=+ngTh.value, rel=+ngRel.value;
    const dt=1/60; const gg=gateGain.gain.value; if(dbfs>th) gateGain.gain.value=1; else gateGain.gain.value=Math.max(0, gg - dt/rel);

    analyser.getByteTimeDomainData(td);
    let sumO=0, peak=0; for(let i=0;i<td.length;i++){ const v=(td[i]-128)/128; sumO+=v*v; peak=Math.max(peak,Math.abs(v)); }
    const rmsOut=Math.sqrt(sumO/td.length); drawVU(g, vuCanvas, rmsOut);
    if(peak>0.98){ clipLED.style.backgroundColor='#ef4444'; setTimeout(()=>clipLED.style.backgroundColor='#64748b', 250); }
    const red=(limiter && typeof limiter.reduction==='number')? Math.max(0,-limiter.reduction):0; gr.textContent=red.toFixed(1);
    rafId=requestAnimationFrame(step);
  };
  cancelAnimationFrame(rafId); rafId=requestAnimationFrame(step);
}

function drawVU(ctx2, canvas, norm){
  const w=canvas.clientWidth, h=canvas.clientHeight;
  ctx2.clearRect(0,0,w,h);
  const leds=28, pad=6, gap=2, usable=w-pad*2, ledW=(usable-gap*(leds-1))/leds, ledH=Math.max(8,h-6), y=(h-ledH)/2;
  const active=Math.round(Math.max(0,Math.min(1,norm))*leds);
  for(let i=0;i<leds;i++){
    const x=pad+i*(ledW+gap); const pct=i/(leds-1); let col='#22c55e'; if(pct>0.70&&pct<=0.9) col='#eab308'; if(pct>0.9) col='#ef4444';
    ctx2.fillStyle = i<active? col : 'rgba(148,163,184,0.18)';
    roundRect(ctx2,x,y,ledW,ledH,3,true);
    if(i<active){ ctx2.fillStyle='rgba(255,255,255,0.18)'; roundRect(ctx2,x+1,y+1,Math.max(1,ledW-2),Math.max(2,ledH*0.35),2,true); }
  }
}
function roundRect(ctx2,x,y,w,h,r,fill){ ctx2.beginPath(); ctx2.moveTo(x+r,y); ctx2.arcTo(x+w,y,x+w,y+h,r); ctx2.arcTo(x+w,y+h,x,y+h,r); ctx2.arcTo(x,y+h,x,y,r); ctx2.arcTo(x,y,x+w,y,r); if(fill) ctx2.fill(); else ctx2.stroke(); }

// ====== Presets & Slots ======
function currentState(){
  return {
    mic:{ model:micModel.value, prox:+prox.value, pad:+pad.value },
    drive:{ amt:+drive.value, cut:+toneCut.value, lvl:+level.value },
    eq:{ l:+eqLS.value, m:+eqMS.value, h:+eqHS.value },
    fx:{ dly:+dlyTime.value, fb:+dlyFBSl.value, mix:+dlyMix.value, rvb:+rvbMix.value },
    dyn:{ cth:+cpTh.value, cra:+cpRa.value, gth:+ngTh.value, grel:+ngRel.value },
    out:+out.value
  };
}
function applyState(s){
  if(!s) return;
  micModel.value=s.mic?.model||'bullet';
  prox.value=s.mic?.prox??4; proxV.textContent=(prox.value>0?'+':'')+prox.value; if(proxShelf) proxShelf.gain.value=+prox.value;
  pad.value=s.mic?.pad??0; padV.textContent=pad.value; if(pre) pre.gain.value=dBToLin(+pad.value);
  applyMicModel(micModel.value);

  drive.value=s.drive?.amt??32; driveV.textContent=drive.value; if(shaper) shaper.curve=makeDriveCurve(+drive.value);
  toneCut.value=s.drive?.cut??4200; toneCutV.textContent=toneCut.value; if(toneLP) toneLP.frequency.value=+toneCut.value;
  level.value=s.drive?.lvl??0; levelV.textContent=level.value; if(levelGain) levelGain.gain.value=dBToLin(+level.value);

  eqLS.value=s.eq?.l??2; eqLV.textContent=(eqLS.value>0?'+':'')+eqLS.value; if(eqL) eqL.gain.value=+eqLS.value;
  eqMS.value=s.eq?.m??-2; eqMV.textContent=(eqMS.value>0?'+':'')+eqMS.value; if(eqM) eqM.gain.value=+eqMS.value;
  eqHS.value=s.eq?.h??-1; eqHV.textContent=(eqHS.value>0?'+':'')+eqHS.value; if(eqH) eqH.gain.value=+eqHS.value;

  dlyTime.value=s.fx?.dly??0.12; dlyTimeV.textContent=parseFloat(dlyTime.value).toFixed(2); if(dly) dly.delayTime.value=+dlyTime.value;
  dlyFBSl.value=s.fx?.fb??0.25; dlyFBV.textContent=parseFloat(dlyFBSl.value).toFixed(2); if(dlyFB) dlyFB.gain.value=+dlyFBSl.value;
  dlyMix.value=s.fx?.mix??0.22; dlyMixV.textContent=parseFloat(dlyMix.value).toFixed(2); if(dlyWet&&dlyDry){ dlyWet.gain.value=+dlyMix.value; dlyDry.gain.value=1-+dlyMix.value; }
  rvbMix.value=s.fx?.rvb??0.18; rvbMixV.textContent=parseFloat(rvbMix.value).toFixed(2); if(rvbWet&&rvbDry){ rvbWet.gain.value=+rvbMix.value; rvbDry.gain.value=1-+rvbMix.value; }

  cpTh.value=s.dyn?.cth??-22; cpThV.textContent=cpTh.value; if(comp) comp.threshold.value=+cpTh.value;
  cpRa.value=s.dyn?.cra??2.5; cpRaV.textContent=cpRa.value; if(comp) comp.ratio.value=+cpRa.value;
  ngTh.value=s.dyn?.gth??-70; ngThV.textContent=ngTh.value;
  ngRel.value=s.dyn?.grel??0.2; ngRelV.textContent=ngRel.value;

  out.value=s.out??1.0; outV.textContent=parseFloat(out.value).toFixed(2); if(outGain) outGain.gain.value=+out.value;
}
function saveState(){ localStorage.setItem('harp_full_state', JSON.stringify(currentState())); }
function restoreState(){ try{ const s=JSON.parse(localStorage.getItem('harp_full_state')||'null'); if(s) applyState(s); }catch(_){} }

const builtIns={
  "Chicago Crunch": { mic:{model:'bullet',prox:6,pad:-2}, drive:{amt:42,cut:3800,lvl:1}, eq:{l:3,m:-3,h:-2}, fx:{dly:0.12,fb:0.28,mix:0.26,rvb:0.20}, dyn:{cth:-22,cra:2.5,gth:-70,grel:0.2}, out:1.0 },
  "Little Walter": { mic:{model:'bullet',prox:7,pad:-4}, drive:{amt:55,cut:3600,lvl:2}, eq:{l:4,m:-4,h:-3}, fx:{dly:0.11,fb:0.22,mix:0.22,rvb:0.24}, dyn:{cth:-24,cra:2.5,gth:-68,grel:0.22}, out:1.0 },
  "Clean Amp":     { mic:{model:'sm57',prox:2,pad:0},  drive:{amt:18,cut:7000,lvl:0}, eq:{l:1,m:0,h:1}, fx:{dly:0.15,fb:0.18,mix:0.12,rvb:0.18}, dyn:{cth:-26,cra:2,gth:-72,grel:0.24}, out:1.0 },
  "Slapback King": { mic:{model:'bullet',prox:5,pad:-3}, drive:{amt:35,cut:5000,lvl:1}, eq:{l:3,m:-2,h:-1}, fx:{dly:0.10,fb:0.34,mix:0.30,rvb:0.16}, dyn:{cth:-23,cra:2.2,gth:-70,grel:0.22}, out:1.0 },
  "Dark Room":     { mic:{model:'cond', prox:4,pad:0},  drive:{amt:28,cut:3200,lvl:0}, eq:{l:2,m:-1,h:-3}, fx:{dly:0.14,fb:0.25,mix:0.22,rvb:0.30}, dyn:{cth:-24,cra:2.5,gth:-70,grel:0.22}, out:1.0 },
  "Bright Cut":    { mic:{model:'sm57',prox:3,pad:-1}, drive:{amt:38,cut:4500,lvl:0}, eq:{l:2,m:-1,h:-4}, fx:{dly:0.12,fb:0.22,mix:0.20,rvb:0.18}, dyn:{cth:-22,cra:2.3,gth:-70,grel:0.20}, out:1.0 },
};
presetApply.addEventListener('click', ()=>{ const n=presetSel.value; if(builtIns[n]){ applyState(builtIns[n]); saveState(); } });

// Slots (10)
function slotStoreKey(){ return 'harp_slots_v1'; }
function slots(){ try{ const arr=JSON.parse(localStorage.getItem(slotStoreKey())||'[]'); if(Array.isArray(arr)&&arr.length===10) return arr; }catch(_){ } return new Array(10).fill(null).map((_,i)=>({name:`Slot ${i+1}`, data:null})); }
function saveSlots(arr){ localStorage.setItem(slotStoreKey(), JSON.stringify(arr)); }
function initSlotsUI(){ const s=slots(); slotSel.innerHTML=''; slotGrid.innerHTML=''; s.forEach((it,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=`${i+1}. ${it?.name||('Slot '+(i+1))}`; slotSel.appendChild(o); const b=document.createElement('button'); b.className='px-2 py-1 text-[11px] rounded-md bg-slate-900/60 ring-1 ring-slate-600'; b.textContent=o.textContent; b.onclick=()=>{ slotSel.value=i; if(s[i]?.data) applyState(s[i].data); }; slotGrid.appendChild(b); }); }
slotLoad.addEventListener('click', ()=>{ const i=+slotSel.value||0; const s=slots(); if(s[i]?.data) applyState(s[i].data); });
slotSave.addEventListener('click', ()=>{ const i=+slotSel.value||0; const s=slots(); const nm=prompt('Name this preset:', s[i]?.name || `Slot ${i+1}`) || `Slot ${i+1}`; s[i]={name:nm, data:currentState()}; saveSlots(s); initSlotsUI(); saveState(); });
slotRename.addEventListener('click', ()=>{ const i=+slotSel.value||0; const s=slots(); const nm=prompt('Rename slot:', s[i]?.name || `Slot ${i+1}`); if(nm){ s[i].name=nm; saveSlots(s); initSlotsUI(); } });
slotExport.addEventListener('click', ()=>{ const data={ slots:slots(), current:currentState() }; const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='harp_presets.json'; a.click(); });
slotImport.addEventListener('click', ()=> importFile.click());
importFile.addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const txt=await f.text().catch(()=>null); if(!txt) return; try{ const data=JSON.parse(txt); if(Array.isArray(data?.slots)) saveSlots(data.slots); initSlotsUI(); if(data?.current) applyState(data.current); toast('Imported presets.'); }catch(_){ toast('Bad preset file'); } });
</script>
</body>
</html>
