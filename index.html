<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>HARP FX CREATED BY MOONSKAI LABS L.L.C.</title>

<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>

<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config={
  theme:{
    extend:{
      fontFamily:{sans:['Inter','system-ui','sans-serif'],display:['Orbitron','Inter','system-ui','sans-serif']},
      colors:{accent:{DEFAULT:'#38bdf8',deep:'#0ea5e9'},panel:'#1e293b'},
      boxShadow:{glow:'0 0 15px rgba(56,189,248,0.3)',panel:'0 14px 32px rgba(0,0,0,.5)'}
    }
  }
};
</script>

<style>
/* Custom Range Sliders */
:root{--slider-h:24px;--slider-track:8px;--thumb:18px;}
.hslider{-webkit-appearance:none;appearance:none;width:100%;height:var(--slider-h);background:transparent;cursor:pointer;touch-action:pan-y}
.hslider:focus{outline:none}
.hslider::-webkit-slider-runnable-track{height:var(--slider-track);background:linear-gradient(90deg,#1e293b,#334155);border-radius:999px;box-shadow:inset 0 1px 2px rgba(0,0,0,0.5);}
.hslider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:var(--thumb);height:var(--thumb);border-radius:50%;background:#e0f2fe;border:2px solid #38bdf8;margin-top:calc((var(--slider-track) - var(--thumb))/2);box-shadow:0 2px 5px rgba(0,0,0,0.4);}
.hslider::-moz-range-track{height:var(--slider-track);background:linear-gradient(90deg,#1e293b,#334155);border-radius:999px;}
.hslider::-moz-range-thumb{width:var(--thumb);height:var(--thumb);border-radius:50%;background:#e0f2fe;border:2px solid #38bdf8;}

/* Toggle Switches */
.toggle-pill{position:relative;display:inline-flex;height:20px;width:40px;align-items:center;border-radius:99px;background:#0f172a;border:1px solid #334155;transition:all 0.2s;}
.toggle-dot{position:absolute;left:2px;height:14px;width:14px;border-radius:50%;background:#94a3b8;transition:transform 0.2s;}
.toggle-on{background:#0ea5e9;border-color:#38bdf8;}
.toggle-on .toggle-dot{background:#fff;transform:translateX(20px);}

/* Canvas & Meters */
canvas{display:block;width:100%;height:100%;}
.meter-box{background:#0f172a;border:1px solid #334155;border-radius:6px;overflow:hidden;position:relative;}
.led{width:8px;height:8px;border-radius:50%;background:#334155;transition:background 0.1s;}
.led.on{background:#22c55e;box-shadow:0 0 8px #22c55e;}
.led.clip{background:#ef4444;box-shadow:0 0 8px #ef4444;}

/* Slot Grid */
.slot-btn { @apply text-[10px] bg-slate-900 border border-slate-700 rounded px-2 py-2 text-slate-400 hover:bg-slate-800 hover:text-white hover:border-sky-500/50 transition-all truncate; }
.slot-btn.active { @apply bg-sky-900/30 border-sky-500 text-sky-300; }
.slot-btn.empty { @apply opacity-50 border-dashed; }

#toast{position:fixed;top:-100px;left:50%;transform:translateX(-50%);background:#ef4444;color:#fff;padding:8px 16px;border-radius:8px;font-weight:700;transition:top 0.3s;z-index:9999;box-shadow:0 10px 25px rgba(0,0,0,0.5);}
</style>
</head>

<body class="min-h-screen bg-[radial-gradient(circle_at_top,#1e293b,#020617)] text-slate-200 font-sans selection:bg-accent selection:text-white pb-10">

<div id="toast">Error</div>

<div class="max-w-5xl mx-auto p-2 sm:p-4 space-y-4">
  
  <header class="bg-slate-900/80 backdrop-blur-md border border-slate-700/50 rounded-2xl p-4 shadow-panel flex flex-col md:flex-row items-center justify-between gap-4">
    <div class="text-center md:text-left">
      <h1 class="font-display text-2xl md:text-3xl text-transparent bg-clip-text bg-gradient-to-r from-sky-300 to-indigo-400 drop-shadow-sm">HARP FX<span class="text-xs font-sans text-slate-500 tracking-wider align-middle border border-slate-700 rounded px-1 ml-2">MOONSKAI LABS L.L.C.</span></h1>
      <p class="text-xs text-slate-400 mt-1">copyright 2026 all rights reserved</p>
    </div>
    
    <div class="flex flex-wrap items-center justify-center gap-3">
      <div class="flex flex-col items-end mr-2">
         <div class="text-[10px] text-slate-400 font-mono" id="latency-stat">LATENCY: —</div>
         <div class="text-[10px] text-slate-400 font-mono" id="sr-stat">SR: —</div>
      </div>
      <button id="btn-start" class="bg-gradient-to-b from-sky-500 to-sky-700 hover:from-sky-400 hover:to-sky-600 text-white font-bold py-2 px-6 rounded-full shadow-glow transition-all active:scale-95 text-sm">
        START AUDIO
      </button>
      <div class="flex items-center gap-2 bg-slate-950/50 px-3 py-1.5 rounded-full border border-slate-800">
        <div id="status-led" class="led"></div>
        <span id="status-text" class="text-xs font-bold text-slate-500">OFF</span>
      </div>
    </div>
  </header>

  <section class="grid grid-cols-1 md:grid-cols-12 gap-4">
    <div class="md:col-span-8 bg-slate-800/50 border border-slate-700/50 rounded-2xl p-4 shadow-lg">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-xs font-bold text-sky-400 uppercase tracking-widest">Input Stage</h2>
        <div class="flex gap-2">
            <select id="dev-select" class="bg-slate-950 text-xs rounded px-2 py-1 border border-slate-700 max-w-[140px] truncate"></select>
            <button id="dev-refresh" class="text-[10px] bg-slate-700 px-2 rounded hover:bg-slate-600">↻</button>
        </div>
      </div>
      
      <div class="grid grid-cols-12 gap-4">
        <div class="col-span-12 sm:col-span-4 bg-slate-900/50 rounded-xl p-3 border border-slate-700/30">
          <label class="block text-[10px] text-slate-400 mb-1">MIC EMULATION</label>
          <select id="mic-model" class="w-full bg-slate-950 text-sm text-sky-200 rounded px-2 py-1.5 border border-slate-600 mb-2 focus:ring-1 focus:ring-sky-500 outline-none">
            <option value="bullet">Green Bullet</option>
            <option value="sm57">SM57 Dynamic</option>
            <option value="cond">Condenser</option>
            <option value="none">None (Clean)</option>
          </select>
          <div class="flex justify-between items-center mt-2">
            <label class="text-[10px] text-slate-400">INPUT TRIM</label>
            <span id="input-trim-val" class="text-[10px] font-mono text-sky-300">0dB</span>
          </div>
          <input id="input-trim" type="range" class="hslider" min="-20" max="20" step="0.5" value="0">
        </div>

        <div class="col-span-12 sm:col-span-8 bg-slate-900/50 rounded-xl p-3 border border-slate-700/30">
          <div class="flex justify-between items-center mb-2">
            <label class="text-[10px] font-bold text-slate-300">NOISE GATE</label>
            <button id="gate-btn" class="toggle-pill"><div class="toggle-dot"></div></button>
          </div>
          <div class="grid grid-cols-2 gap-x-4 gap-y-1">
             <div class="flex justify-between text-[10px] text-slate-400"><span>Thresh</span><span id="gate-thresh-val" class="text-sky-300">-60dB</span></div>
             <div class="flex justify-between text-[10px] text-slate-400"><span>Release</span><span id="gate-rel-val" class="text-sky-300">0.2s</span></div>
             <input id="gate-thresh" type="range" class="hslider" min="-80" max="-10" step="1" value="-60">
             <input id="gate-rel" type="range" class="hslider" min="0.01" max="1" step="0.01" value="0.2">
          </div>
          <div class="flex items-center gap-2 mt-3 pt-2 border-t border-slate-700/50">
             <button id="anti-gate-btn" class="toggle-pill scale-75 origin-left"><div class="toggle-dot"></div></button>
             <span class="text-[10px] text-slate-400">ANTI-GATE (Mobile Fix)</span>
          </div>
        </div>
      </div>
    </div>

    <div class="md:col-span-4 bg-slate-800/50 border border-slate-700/50 rounded-2xl p-4 shadow-lg flex flex-col justify-between">
       <div class="flex justify-between items-center mb-1">
         <h2 class="text-xs font-bold text-sky-400 uppercase tracking-widest">Main Output</h2>
         <div id="clip-led" class="led"></div>
       </div>
       <div class="meter-box h-8 mb-2"><canvas id="vu-canvas"></canvas></div>
       
       <div class="flex justify-between items-center mt-2">
         <label class="text-[10px] text-slate-400">MASTER OUT</label>
         <span id="master-out-val" class="text-[10px] font-mono text-sky-300">0.0dB</span>
       </div>
       <input id="master-out" type="range" class="hslider" min="-30" max="6" step="0.5" value="0">
    </div>
  </section>

  <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
    
    <div class="bg-slate-800/80 border border-slate-700 rounded-2xl p-3 shadow-lg relative overflow-hidden group">
      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-orange-500 to-red-500 opacity-70"></div>
      <div class="flex justify-between items-center mb-3">
        <h3 class="font-display text-sm text-orange-200">TUBE DRIVE</h3>
        <button id="drive-btn" class="toggle-pill"><div class="toggle-dot"></div></button>
      </div>
      <div class="space-y-3">
        <div>
          <div class="flex justify-between text-[10px] text-slate-400 mb-1"><span>Gain</span><span id="drive-gain-val" class="text-orange-300">25</span></div>
          <input id="drive-gain" type="range" class="hslider" min="0" max="100" step="1" value="25">
        </div>
        <div>
          <div class="flex justify-between text-[10px] text-slate-400 mb-1"><span>Mix</span><span id="drive-mix-val" class="text-orange-300">60%</span></div>
          <input id="drive-mix" type="range" class="hslider" min="0" max="1" step="0.01" value="0.6">
        </div>
      </div>
    </div>

    <div class="bg-slate-800/80 border border-slate-700 rounded-2xl p-3 shadow-lg relative overflow-hidden">
      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-green-500 to-emerald-500 opacity-70"></div>
      <div class="flex justify-between items-center mb-3">
        <h3 class="font-display text-sm text-green-200">TONE STACK</h3>
      </div>
      <div class="space-y-2">
         <div class="flex items-center gap-2">
            <span class="text-[10px] w-8 text-slate-400">LOW</span>
            <input id="eq-low" type="range" class="hslider flex-1" min="-12" max="12" step="0.5" value="0">
            <span id="eq-low-val" class="text-[10px] w-8 text-right font-mono text-green-300">0</span>
         </div>
         <div class="flex items-center gap-2">
            <span class="text-[10px] w-8 text-slate-400">MID</span>
            <input id="eq-mid" type="range" class="hslider flex-1" min="-12" max="12" step="0.5" value="0">
            <span id="eq-mid-val" class="text-[10px] w-8 text-right font-mono text-green-300">0</span>
         </div>
         <div class="flex items-center gap-2">
            <span class="text-[10px] w-8 text-slate-400">HIGH</span>
            <input id="eq-high" type="range" class="hslider flex-1" min="-12" max="12" step="0.5" value="0">
            <span id="eq-high-val" class="text-[10px] w-8 text-right font-mono text-green-300">0</span>
         </div>
      </div>
    </div>

    <div class="bg-slate-800/80 border border-slate-700 rounded-2xl p-3 shadow-lg relative overflow-hidden">
      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-cyan-500 opacity-70"></div>
      <div class="flex justify-between items-center mb-3">
        <h3 class="font-display text-sm text-cyan-200">COMPRESSOR</h3>
        <button id="comp-btn" class="toggle-pill"><div class="toggle-dot"></div></button>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <div class="flex justify-between text-[10px] text-slate-400 mb-1"><span>Thresh</span><span id="comp-thresh-val" class="text-cyan-300">-24</span></div>
          <input id="comp-thresh" type="range" class="hslider" min="-60" max="0" step="1" value="-24">
        </div>
        <div>
           <div class="flex justify-between text-[10px] text-slate-400 mb-1"><span>Ratio</span><span id="comp-ratio-val" class="text-cyan-300">3:1</span></div>
           <input id="comp-ratio" type="range" class="hslider" min="1" max="20" step="0.5" value="3">
        </div>
      </div>
      <div class="mt-2 text-[10px] text-slate-500 text-center flex justify-between px-1">
        <span>GR: <span id="comp-gr" class="text-cyan-400">0.0</span>dB</span>
        <span>Auto-Makeup</span>
      </div>
    </div>

    <div class="bg-slate-800/80 border border-slate-700 rounded-2xl p-3 shadow-lg relative overflow-hidden">
       <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-purple-500 to-fuchsia-500 opacity-70"></div>
       <div class="flex justify-between items-center mb-3">
         <h3 class="font-display text-sm text-purple-200">SLAPBACK</h3>
         <button id="dly-btn" class="toggle-pill"><div class="toggle-dot"></div></button>
       </div>
       <div class="space-y-2">
          <div class="flex items-center gap-2">
             <span class="text-[10px] w-8 text-slate-400">TIME</span>
             <input id="dly-time" type="range" class="hslider flex-1" min="0.01" max="0.4" step="0.01" value="0.12">
             <span id="dly-time-val" class="text-[10px] w-8 text-right font-mono text-purple-300">.12s</span>
          </div>
          <div class="flex items-center gap-2">
             <span class="text-[10px] w-8 text-slate-400">FDBK</span>
             <input id="dly-fb" type="range" class="hslider flex-1" min="0" max="0.8" step="0.01" value="0.2">
             <span id="dly-fb-val" class="text-[10px] w-8 text-right font-mono text-purple-300">20%</span>
          </div>
          <div class="flex items-center gap-2">
             <span class="text-[10px] w-8 text-slate-400">MIX</span>
             <input id="dly-mix" type="range" class="hslider flex-1" min="0" max="0.6" step="0.01" value="0.2">
             <span id="dly-mix-val" class="text-[10px] w-8 text-right font-mono text-purple-300">20%</span>
          </div>
       </div>
    </div>

    <div class="bg-slate-800/80 border border-slate-700 rounded-2xl p-3 shadow-lg relative overflow-hidden">
      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 to-violet-500 opacity-70"></div>
      <div class="flex justify-between items-center mb-3">
        <h3 class="font-display text-sm text-indigo-200">ROOM REVERB</h3>
        <button id="rvb-btn" class="toggle-pill"><div class="toggle-dot"></div></button>
      </div>
      <div class="space-y-3">
        <div>
          <div class="flex justify-between text-[10px] text-slate-400 mb-1"><span>Size (Decay)</span><span id="rvb-time-val" class="text-indigo-300">1.5s</span></div>
          <input id="rvb-time" type="range" class="hslider" min="0.5" max="3.0" step="0.1" value="1.5">
        </div>
        <div>
          <div class="flex justify-between text-[10px] text-slate-400 mb-1"><span>Mix</span><span id="rvb-mix-val" class="text-indigo-300">15%</span></div>
          <input id="rvb-mix" type="range" class="hslider" min="0" max="0.5" step="0.01" value="0.15">
        </div>
      </div>
    </div>

    <div class="bg-slate-800/80 border border-slate-700 rounded-2xl p-3 shadow-lg relative overflow-hidden">
      <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-slate-500 to-gray-500 opacity-70"></div>
      <div class="flex justify-between items-center mb-3">
        <h3 class="font-display text-sm text-slate-200">UTILITY</h3>
      </div>
      <div class="space-y-3">
        <div>
           <div class="flex justify-between items-center mb-1">
              <label class="text-[10px] text-slate-400">HUM SLAYER (60/120Hz)</label>
              <span id="hum-amt-val" class="text-[10px] text-slate-300">100%</span>
           </div>
           <input id="hum-amt" type="range" class="hslider" min="0" max="1" step="0.1" value="1">
        </div>
        <div>
           <div class="flex justify-between items-center mb-1">
              <label class="text-[10px] text-slate-400">AIR CUT (LPF)</label>
              <button id="lpf-btn" class="toggle-pill scale-75 origin-right"><div class="toggle-dot"></div></button>
           </div>
           <input id="lpf-freq" type="range" class="hslider" min="2000" max="12000" step="100" value="6000">
           <div class="text-right text-[10px] text-slate-500 mt-1" id="lpf-freq-val">6000Hz</div>
        </div>
      </div>
    </div>

  </section>

  <section class="bg-slate-800/50 border border-slate-700/50 rounded-2xl p-4 shadow-lg">
    <div class="flex flex-col md:flex-row gap-4 items-start md:items-center justify-between mb-4 border-b border-slate-700/50 pb-3">
      <div>
         <h2 class="text-xs font-bold text-sky-400 uppercase tracking-widest">Preset Bank</h2>
         <p class="text-[10px] text-slate-500 mt-0.5">Built-in tones + 10 user slots</p>
      </div>
      
      <div class="flex gap-2 w-full md:w-auto">
        <select id="preset-sel" class="bg-slate-950 text-xs text-sky-100 rounded px-2 py-1.5 border border-slate-700 flex-1 md:w-56 focus:border-sky-500 outline-none"></select>
        <button id="preset-load" class="text-[10px] bg-sky-700/80 hover:bg-sky-600 text-white px-3 py-1 rounded font-bold transition-colors">LOAD BUILT-IN</button>
      </div>
    </div>
    
    <div class="flex flex-col gap-3">
        <div class="flex flex-wrap gap-2 items-center">
            <span class="text-[10px] font-bold text-slate-400 mr-1">USER SLOTS:</span>
            <button id="slot-save" class="text-[10px] bg-emerald-800/60 hover:bg-emerald-700 border border-emerald-700/50 text-emerald-100 px-3 py-1.5 rounded transition-colors">SAVE</button>
            <button id="slot-rename" class="text-[10px] bg-slate-700 hover:bg-slate-600 border border-slate-600 text-slate-200 px-3 py-1.5 rounded transition-colors">RENAME</button>
            <span class="w-px h-4 bg-slate-700 mx-1"></span>
            <button id="slot-export" class="text-[10px] bg-slate-700 hover:bg-slate-600 border border-slate-600 text-slate-200 px-3 py-1.5 rounded transition-colors">EXPORT</button>
            <button id="slot-import" class="text-[10px] bg-slate-700 hover:bg-slate-600 border border-slate-600 text-slate-200 px-3 py-1.5 rounded transition-colors">IMPORT</button>
            <input type="file" id="import-file" class="hidden" accept=".json">
        </div>

        <div id="slot-grid" class="grid grid-cols-2 sm:grid-cols-5 gap-2 mt-1">
             </div>
    </div>
  </section>

</div>

<script>
/* --- UTILS --- */
const $ = (id) => document.getElementById(id);
const dbToLin = (db) => Math.pow(10, db/20);
const clamp = (v,min,max) => Math.min(max, Math.max(min,v));
function setToggle(btn, on) { 
  if(!btn) return; 
  btn.classList.toggle('toggle-on', on); 
}
function isOn(btn) { return btn && btn.classList.contains('toggle-on'); }
function showToast(msg) { 
  const t = $('toast'); t.textContent = msg; t.style.top = '20px'; 
  setTimeout(() => t.style.top = '-100px', 2500); 
}

/* --- STATE --- */
let ctx = null, stream = null, src = null;
let nodes = {}; 
let running = false;
let rafId = null;
let currentDevId = null;
let antiGateSrc = null;

/* --- PRESETS DATA --- */
const BUILTINS = {
  "Classic Chicago": { mic:'bullet', trim:2, gate:{on:true,th:-55,rel:0.2}, drive:{on:true,gain:32,mix:0.7}, eq:{l:3,m:1,h:2}, comp:{on:true,th:-24,rat:3.5}, dly:{on:true,t:0.14,fb:0.28,mix:0.1}, rvb:{on:true,t:1.3,mix:0.14}, lpf:{on:true,f:9000}, out:0 },
  "Crunch Amp":      { mic:'sm57', trim:0, gate:{on:true,th:-58,rel:0.18}, drive:{on:true,gain:26,mix:0.55}, eq:{l:2,m:0,h:2}, comp:{on:true,th:-20,rat:4}, dly:{on:false,t:0.12,fb:0.2,mix:0}, rvb:{on:true,t:1.2,mix:0.1}, lpf:{on:true,f:8500}, out:0 },
  "Fat Low End":     { mic:'bullet', trim:0, gate:{on:true,th:-60,rel:0.18}, drive:{on:true,gain:22,mix:0.5}, eq:{l:4,m:-1,h:1}, comp:{on:true,th:-26,rat:3}, dly:{on:true,t:0.12,fb:0.22,mix:0.1}, rvb:{on:true,t:1.4,mix:0.12}, lpf:{on:true,f:8000}, out:0 },
  "Bright Cut":      { mic:'sm57', trim:0, gate:{on:true,th:-58,rel:0.16}, drive:{on:false,gain:12,mix:0.35}, eq:{l:1,m:0,h:3}, comp:{on:true,th:-22,rat:2.5}, dly:{on:false,t:0.11,fb:0.18,mix:0}, rvb:{on:true,t:1.2,mix:0.1}, lpf:{on:false,f:12000}, out:0 },
  "Little Walter Cup":{ mic:'bullet', trim:1, gate:{on:true,th:-54,rel:0.22}, drive:{on:true,gain:28,mix:0.65}, eq:{l:3,m:1,h:2}, comp:{on:true,th:-24,rat:3.2}, dly:{on:true,t:0.13,fb:0.26,mix:0.12}, rvb:{on:true,t:1.4,mix:0.18}, lpf:{on:true,f:8200}, out:-1 },
  "Country Clean":   { mic:'cond', trim:0, gate:{on:true,th:-60,rel:0.16}, drive:{on:false,gain:10,mix:0.3}, eq:{l:1,m:1,h:2}, comp:{on:true,th:-18,rat:2}, dly:{on:true,t:0.1,fb:0.18,mix:0.12}, rvb:{on:true,t:1.1,mix:0.12}, lpf:{on:false,f:12000}, out:0 },
  "Dark Mellow":     { mic:'bullet', trim:0, gate:{on:true,th:-60,rel:0.22}, drive:{on:false,gain:8,mix:0.25}, eq:{l:3,m:-1,h:-2}, comp:{on:true,th:-24,rat:2.5}, dly:{on:false,t:0.12,fb:0.2,mix:0}, rvb:{on:true,t:1.6,mix:0.16}, lpf:{on:true,f:7000}, out:0 },
  "Lo-Fi Amp":       { mic:'bullet', trim:0, gate:{on:true,th:-58,rel:0.18}, drive:{on:true,gain:40,mix:0.75}, eq:{l:-2,m:2,h:-3}, comp:{on:true,th:-22,rat:6}, dly:{on:false,t:0.09,fb:0.15,mix:0}, rvb:{on:false,t:1.0,mix:0}, lpf:{on:true,f:6000}, out:-1.5 },
  "Big Room":        { mic:'cond', trim:0, gate:{on:true,th:-58,rel:0.2}, drive:{on:false,gain:12,mix:0.35}, eq:{l:2,m:0,h:2}, comp:{on:true,th:-26,rat:2.5}, dly:{on:true,t:0.18,fb:0.3,mix:0.16}, rvb:{on:true,t:1.9,mix:0.28}, lpf:{on:false,f:12000}, out:-0.5 },
  "Cut Through Band":{ mic:'sm57', trim:0, gate:{on:true,th:-56,rel:0.18}, drive:{on:true,gain:30,mix:0.65}, eq:{l:2,m:2,h:2}, comp:{on:true,th:-20,rat:4}, dly:{on:true,t:0.12,fb:0.22,mix:0.12}, rvb:{on:true,t:1.2,mix:0.12}, lpf:{on:true,f:9500}, out:-0.5 },
  "Modern Blues Rock":{ mic:'sm57', trim:0, gate:{on:true,th:-55,rel:0.2}, drive:{on:true,gain:35,mix:0.72}, eq:{l:3,m:1,h:2}, comp:{on:true,th:-18,rat:5}, dly:{on:false,t:0.11,fb:0.2,mix:0}, rvb:{on:true,t:1.1,mix:0.1}, lpf:{on:true,f:9000}, out:-1 },
  "Vintage Jazz Tone":{ mic:'cond', trim:0, gate:{on:true,th:-60,rel:0.22}, drive:{on:false,gain:8,mix:0.25}, eq:{l:2,m:-2,h:-1}, comp:{on:true,th:-22,rat:2}, dly:{on:false,t:0.12,fb:0.18,mix:0}, rvb:{on:true,t:1.6,mix:0.16}, lpf:{on:false,f:12000}, out:0 },
  "Country Bright":  { mic:'sm57', trim:0, gate:{on:true,th:-60,rel:0.16}, drive:{on:false,gain:10,mix:0.3}, eq:{l:0,m:1,h:3}, comp:{on:true,th:-18,rat:2.2}, dly:{on:true,t:0.09,fb:0.16,mix:0.12}, rvb:{on:true,t:1.0,mix:0.12}, lpf:{on:false,f:12000}, out:0 }
};

/* --- USER SLOTS SYSTEM --- */
const SLOT_KEY = 'harp_slots_v2';
let userSlots = [];
let selectedSlot = 0;

function initSlots() {
  try {
    const raw = localStorage.getItem(SLOT_KEY);
    userSlots = raw ? JSON.parse(raw) : [];
  } catch(e) { userSlots = []; }
  
  if (userSlots.length !== 10) {
    userSlots = Array(10).fill(null).map((_,i) => ({ name: `Slot ${i+1}`, data: null }));
  }
  renderSlotGrid();
}

function renderSlotGrid() {
  const grid = $('slot-grid');
  grid.innerHTML = '';
  userSlots.forEach((slot, i) => {
    const btn = document.createElement('button');
    btn.className = `slot-btn ${i === selectedSlot ? 'active' : ''} ${!slot.data ? 'empty' : ''}`;
    btn.textContent = `${i+1}. ${slot.name}`;
    btn.onclick = () => {
      selectedSlot = i;
      renderSlotGrid();
      if (slot.data) loadState(slot.data);
    };
    grid.appendChild(btn);
  });
}

function saveToSlot() {
  userSlots[selectedSlot] = {
    name: userSlots[selectedSlot].name,
    data: getCurrentState()
  };
  localStorage.setItem(SLOT_KEY, JSON.stringify(userSlots));
  renderSlotGrid();
  showToast(`Saved to ${userSlots[selectedSlot].name}`);
}

function renameSlot() {
  const newName = prompt("Rename Slot:", userSlots[selectedSlot].name);
  if (newName) {
    userSlots[selectedSlot].name = newName;
    localStorage.setItem(SLOT_KEY, JSON.stringify(userSlots));
    renderSlotGrid();
  }
}

function exportSlots() {
  const blob = new Blob([JSON.stringify(userSlots, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'harp_presets.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importSlots(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const data = JSON.parse(ev.target.result);
      if (Array.isArray(data) && data.length === 10) {
        userSlots = data;
        localStorage.setItem(SLOT_KEY, JSON.stringify(userSlots));
        renderSlotGrid();
        showToast("Presets Imported");
      } else {
        showToast("Invalid Preset File");
      }
    } catch(err) { showToast("Error Reading File"); }
  };
  reader.readAsText(file);
  e.target.value = ''; // reset
}

/* --- STATE MANAGEMENT --- */
function getCurrentState() {
  return {
    mic: $('mic-model').value,
    trim: $('input-trim').value,
    gate: { on: isOn($('gate-btn')), th: $('gate-thresh').value, rel: $('gate-rel').value },
    drive: { on: isOn($('drive-btn')), gain: $('drive-gain').value, mix: $('drive-mix').value },
    eq: { l: $('eq-low').value, m: $('eq-mid').value, h: $('eq-high').value },
    comp: { on: isOn($('comp-btn')), th: $('comp-thresh').value, rat: $('comp-ratio').value },
    dly: { on: isOn($('dly-btn')), t: $('dly-time').value, fb: $('dly-fb').value, mix: $('dly-mix').value },
    rvb: { on: isOn($('rvb-btn')), t: $('rvb-time').value, mix: $('rvb-mix').value },
    lpf: { on: isOn($('lpf-btn')), f: $('lpf-freq').value },
    hum: $('hum-amt').value,
    out: $('master-out').value
  };
}

function loadState(s) {
  if(!s) return;
  $('mic-model').value = s.mic || 'bullet';
  $('input-trim').value = s.trim || 0;
  
  setToggle($('gate-btn'), s.gate?.on);
  $('gate-thresh').value = s.gate?.th || -60;
  $('gate-rel').value = s.gate?.rel || 0.2;
  
  setToggle($('drive-btn'), s.drive?.on);
  $('drive-gain').value = s.drive?.gain || 25;
  $('drive-mix').value = s.drive?.mix || 0.6;
  
  $('eq-low').value = s.eq?.l || 0;
  $('eq-mid').value = s.eq?.m || 0;
  $('eq-high').value = s.eq?.h || 0;
  
  setToggle($('comp-btn'), s.comp?.on);
  $('comp-thresh').value = s.comp?.th || -24;
  $('comp-ratio').value = s.comp?.rat || 3;
  
  setToggle($('dly-btn'), s.dly?.on);
  $('dly-time').value = s.dly?.t || 0.12;
  $('dly-fb').value = s.dly?.fb || 0.2;
  $('dly-mix').value = s.dly?.mix || 0.2;
  
  setToggle($('rvb-btn'), s.rvb?.on);
  $('rvb-time').value = s.rvb?.t || 1.5;
  $('rvb-mix').value = s.rvb?.mix || 0.15;
  
  setToggle($('lpf-btn'), s.lpf?.on);
  $('lpf-freq').value = s.lpf?.f || 6000;
  
  $('hum-amt').value = s.hum || 1;
  $('master-out').value = s.out || 0;
  
  // Update UI text & Audio
  document.querySelectorAll('input[type=range]').forEach(el => el.dispatchEvent(new Event('input')));
  updateNodesFromUI();
}

/* --- AUDIO ENGINE --- */
async function initAudio() {
  if (running) return;
  
  try {
    ctx = new (window.AudioContext || window.webkitAudioContext)({
      latencyHint: 'interactive', 
    });
    
    const l = (ctx.baseLatency || 0) + (ctx.outputLatency || 0);
    $('latency-stat').textContent = `LAT: ${(l*1000).toFixed(1)}ms`;
    $('sr-stat').textContent = `SR: ${ctx.sampleRate}Hz`;

    const constraints = {
      audio: {
        deviceId: currentDevId ? { exact: currentDevId } : undefined,
        echoCancellation: false, noiseSuppression: false, autoGainControl: false,
        channelCount: 1, sampleRate: 48000,
        googEchoCancellation: false, googEchoCancellation2: false,
        googAutoGainControl: false, googAutoGainControl2: false,
        googNoiseSuppression: false, googHighpassFilter: false, googTypingNoiseDetection: false
      }
    };
    
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    
    const track = stream.getAudioTracks()[0]; 
    try{ await track.applyConstraints({ echoCancellation:false, noiseSuppression:false, autoGainControl:false }); }catch{}
    if('contentHint' in track) track.contentHint = 'music';
    
    buildGraph();
    if(isOn($('anti-gate-btn'))) startAntiGate();

    running = true;
    $('btn-start').textContent = 'STOP AUDIO';
    $('btn-start').className = 'bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full shadow-glow transition-all active:scale-95 text-sm';
    $('status-led').classList.add('on');
    $('status-text').textContent = 'LIVE';
    
    updateNodesFromUI();
    startMeterLoop();
    
  } catch (e) {
    console.error(e);
    showToast("Mic Error: " + e.message);
  }
}

function stopAudio() {
  if (!running) return;
  cancelAnimationFrame(rafId);
  stopAntiGate();
  if (stream) stream.getTracks().forEach(t => t.stop());
  if (ctx) ctx.close();
  running = false;
  $('btn-start').textContent = 'START AUDIO';
  $('btn-start').className = 'bg-gradient-to-b from-sky-500 to-sky-700 hover:from-sky-400 hover:to-sky-600 text-white font-bold py-2 px-6 rounded-full shadow-glow transition-all active:scale-95 text-sm';
  $('status-led').classList.remove('on');
  $('status-text').textContent = 'OFF';
  $('latency-stat').textContent = 'LATENCY: —';
}

function buildGraph() {
  src = ctx.createMediaStreamSource(stream);
  nodes.trim = ctx.createGain();
  nodes.micLS = ctx.createBiquadFilter(); nodes.micLS.type = 'lowshelf'; nodes.micLS.frequency.value = 160;
  nodes.micHS = ctx.createBiquadFilter(); nodes.micHS.type = 'highshelf'; nodes.micHS.frequency.value = 4500;
  
  nodes.hpf = ctx.createBiquadFilter(); nodes.hpf.type = 'highpass'; nodes.hpf.frequency.value = 80;
  // CHANGED FROM NOTCH TO PEAKING FOR GAIN CONTROL
  nodes.hum1 = ctx.createBiquadFilter(); nodes.hum1.type = 'peaking'; nodes.hum1.frequency.value = 60; nodes.hum1.Q.value = 10;
  nodes.hum2 = ctx.createBiquadFilter(); nodes.hum2.type = 'peaking'; nodes.hum2.frequency.value = 120; nodes.hum2.Q.value = 10;
  
  nodes.gate = ctx.createGain();
  
  nodes.shaper = ctx.createWaveShaper(); nodes.shaper.oversample = '4x';
  nodes.driveGain = ctx.createGain(); nodes.driveMix = ctx.createGain(); nodes.dryMix = ctx.createGain(); nodes.driveMerge = ctx.createGain();
  
  nodes.eqL = ctx.createBiquadFilter(); nodes.eqL.type = 'lowshelf'; nodes.eqL.frequency.value = 120;
  nodes.eqM = ctx.createBiquadFilter(); nodes.eqM.type = 'peaking'; nodes.eqM.frequency.value = 900; nodes.eqM.Q.value = 1.0;
  nodes.eqH = ctx.createBiquadFilter(); nodes.eqH.type = 'highshelf'; nodes.eqH.frequency.value = 3500;
  
  nodes.comp = ctx.createDynamicsCompressor(); nodes.comp.attack.value = 0.01;
  
  nodes.dly = ctx.createDelay(1.0); nodes.dlyFb = ctx.createGain(); nodes.dlyWet = ctx.createGain();
  nodes.rvb = ctx.createConvolver(); nodes.rvbWet = ctx.createGain();
  
  nodes.lpf = ctx.createBiquadFilter(); nodes.lpf.type = 'lowpass';
  nodes.lim = ctx.createDynamicsCompressor(); 
  nodes.lim.threshold.value = -0.5; nodes.lim.knee.value = 0; nodes.lim.ratio.value = 20; nodes.lim.attack.value = 0.002; nodes.lim.release.value = 0.1;
  nodes.master = ctx.createGain();
  nodes.analyser = ctx.createAnalyser(); nodes.analyser.fftSize = 2048;

  src.connect(nodes.trim).connect(nodes.micLS).connect(nodes.micHS).connect(nodes.hpf).connect(nodes.hum1).connect(nodes.hum2).connect(nodes.gate);
  
  nodes.gate.connect(nodes.dryMix).connect(nodes.driveMerge);
  nodes.gate.connect(nodes.shaper).connect(nodes.driveGain).connect(nodes.driveMerge);
  
  nodes.driveMerge.connect(nodes.eqL).connect(nodes.eqM).connect(nodes.eqH).connect(nodes.comp);
  
  nodes.comp.connect(nodes.dly).connect(nodes.dlyFb).connect(nodes.dly); nodes.dly.connect(nodes.dlyWet);
  nodes.comp.connect(nodes.rvb).connect(nodes.rvbWet);
  
  nodes.comp.connect(nodes.lpf);
  nodes.dlyWet.connect(nodes.lpf);
  nodes.rvbWet.connect(nodes.lpf);
  
  nodes.lpf.connect(nodes.lim).connect(nodes.master).connect(nodes.analyser).connect(ctx.destination);
}

function startAntiGate() {
  if (antiGateSrc || !ctx) return;
  const len = ctx.sampleRate * 2; const buf = ctx.createBuffer(1, len, ctx.sampleRate);
  const d = buf.getChannelData(0); for (let i = 0; i < len; i++) d[i] = (Math.random() * 2 - 1);
  const s = ctx.createBufferSource(); s.buffer = buf; s.loop = true;
  const g = ctx.createGain(); g.gain.value = 3.0e-5; // tiny noise
  s.connect(g).connect(nodes.trim); s.start();
  antiGateSrc = s;
}
function stopAntiGate() {
  if (antiGateSrc) { try { antiGateSrc.stop(); } catch(e){} antiGateSrc = null; }
}

function makeDistortionCurve(amount) {
  const k = typeof amount === 'number' ? amount : 50;
  const n = 44100; const curve = new Float32Array(n); const deg = Math.PI / 180;
  for (let i = 0; i < n; ++i) { const x = (i * 2) / n - 1; curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x)); }
  return curve;
}
function makeReverbImpulse(seconds, decay) {
  const rate = ctx.sampleRate; const len = rate * seconds; const impulse = ctx.createBuffer(2, len, rate);
  for (let i = 0; i < 2; i++) { const ch = impulse.getChannelData(i); for (let j = 0; j < len; j++) ch[j] = (Math.random() * 2 - 1) * Math.pow(1 - j / len, decay); }
  return impulse;
}

function updateNodesFromUI() {
  if (!running) return;
  const now = ctx.currentTime;
  
  const mod = $('mic-model').value;
  if (mod === 'bullet') { nodes.micLS.gain.value = 6; nodes.micHS.gain.value = -8; }
  else if (mod === 'sm57') { nodes.micLS.gain.value = 3; nodes.micHS.gain.value = -2; }
  else if (mod === 'cond') { nodes.micLS.gain.value = 0; nodes.micHS.gain.value = 2; }
  else { nodes.micLS.gain.value = 0; nodes.micHS.gain.value = 0; }
  
  nodes.trim.gain.setTargetAtTime(dbToLin(+$('input-trim').value), now, 0.02);
  const humAmt = +$('hum-amt').value; 
  // Peaking filters reduce gain at frequency
  nodes.hum1.gain.value = -30 * humAmt; 
  nodes.hum2.gain.value = -30 * humAmt;
  
  const drvOn = isOn($('drive-btn')); const drvGain = +$('drive-gain').value; const drvMix = +$('drive-mix').value;
  nodes.shaper.curve = makeDistortionCurve(drvGain);
  if (drvOn) { nodes.driveGain.gain.setTargetAtTime(drvMix, now, 0.02); nodes.dryMix.gain.setTargetAtTime(1 - drvMix, now, 0.02); } 
  else { nodes.driveGain.gain.setTargetAtTime(0, now, 0.02); nodes.dryMix.gain.setTargetAtTime(1, now, 0.02); }
  
  nodes.eqL.gain.value = +$('eq-low').value; nodes.eqM.gain.value = +$('eq-mid').value; nodes.eqH.gain.value = +$('eq-high').value;
  
  if (isOn($('comp-btn'))) { 
      nodes.comp.threshold.value = +$('comp-thresh').value; 
      nodes.comp.ratio.value = +$('comp-ratio').value; 
  } else { 
      nodes.comp.threshold.value = 0; 
      nodes.comp.ratio.value = 1; 
  }
  
  if (isOn($('dly-btn'))) { nodes.dly.delayTime.value = +$('dly-time').value; nodes.dlyFb.gain.value = +$('dly-fb').value; nodes.dlyWet.gain.value = +$('dly-mix').value; } 
  else { nodes.dlyWet.gain.value = 0; }
  
  if (isOn($('rvb-btn'))) {
      if (!nodes.rvb.buffer || Math.abs(nodes.rvb.duration - +$('rvb-time').value) > 0.1) {
         nodes.rvb.buffer = makeReverbImpulse(+$('rvb-time').value, 2.0); nodes.rvb.duration = +$('rvb-time').value;
      }
      nodes.rvbWet.gain.value = +$('rvb-mix').value;
  } else { nodes.rvbWet.gain.value = 0; }
  
  nodes.lpf.frequency.value = isOn($('lpf-btn')) ? +$('lpf-freq').value : 22000;
  nodes.master.gain.setTargetAtTime(dbToLin(+$('master-out').value), now, 0.02);
}

function startMeterLoop() {
  const vuCtx = $('vu-canvas').getContext('2d');
  const bufferLength = nodes.analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);
  
  function draw() {
    if (!running) return;
    rafId = requestAnimationFrame(draw);
    nodes.analyser.getByteTimeDomainData(dataArray);
    let sum = 0; for(let i = 0; i < bufferLength; i++) { const x = (dataArray[i] - 128) / 128; sum += x * x; }
    const rms = Math.sqrt(sum / bufferLength); const db = 20 * Math.log10(rms || 1e-10);
    const w = $('vu-canvas').width; const h = $('vu-canvas').height;
    vuCtx.clearRect(0, 0, w, h); vuCtx.fillStyle = '#1e293b'; vuCtx.fillRect(0,0,w,h);
    const pct = Math.min(1, (db + 60) / 60); const fillW = w * pct;
    const grad = vuCtx.createLinearGradient(0,0,w,0); grad.addColorStop(0, '#0ea5e9'); grad.addColorStop(0.8, '#22c55e'); grad.addColorStop(1, '#ef4444');
    vuCtx.fillStyle = grad; vuCtx.fillRect(0,0,fillW,h);
    if (rms > 0.95) { $('clip-led').classList.add('clip'); setTimeout(() => $('clip-led').classList.remove('clip'), 100); }
    if (isOn($('comp-btn'))) {
        const th = +$('comp-thresh').value;
        if (db > th) { const ratio = +$('comp-ratio').value; const over = db - th; const red = over - (over / ratio); $('comp-gr').textContent = red.toFixed(1); } else { $('comp-gr').textContent = "0.0"; }
    }
    if (isOn($('gate-btn'))) {
        const th = +$('gate-thresh').value; const rel = +$('gate-rel').value; const target = db > th ? 1.0 : 0.0;
        nodes.gate.gain.setTargetAtTime(target, ctx.currentTime, target === 1.0 ? 0.005 : rel);
    } else { nodes.gate.gain.setTargetAtTime(1.0, ctx.currentTime, 0.02); }
  }
  draw();
}

$('btn-start').onclick = () => { if (running) stopAudio(); else initAudio(); };
$('dev-refresh').onclick = async () => {
   const devs = await navigator.mediaDevices.enumerateDevices();
   const sel = $('dev-select'); sel.innerHTML = '';
   devs.filter(d=>d.kind==='audioinput').forEach(d => { const opt = document.createElement('option'); opt.value = d.deviceId; opt.text = d.label || 'Microphone ' + (sel.length+1); sel.appendChild(opt); });
   if (currentDevId) sel.value = currentDevId;
}; $('dev-refresh').click();
$('dev-select').onchange = (e) => { currentDevId = e.target.value; if(running){stopAudio(); initAudio();} };
$('anti-gate-btn').onclick = () => { setToggle($('anti-gate-btn'), !isOn($('anti-gate-btn'))); if(running) { if(isOn($('anti-gate-btn'))) startAntiGate(); else stopAntiGate(); } };

document.querySelectorAll('input[type=range]').forEach(el => {
   el.addEventListener('input', (e) => {
       const id = e.target.id; const val = e.target.value; const label = $(id + '-val');
       if (label) {
           if (id.includes('dB') || id.includes('trim') || id.includes('thresh') || id.includes('out') || id.includes('gain') || id.includes('mid') || id.includes('low') || id.includes('high')) label.textContent = val + (id.includes('ratio') ? '' : 'dB');
           else if (id.includes('time') || id.includes('rel')) label.textContent = val + 's';
           else if (id.includes('mix') || id.includes('fb') || id.includes('hum')) label.textContent = Math.round(val*100) + '%';
           else if (id.includes('freq') || id.includes('lpf')) label.textContent = val + 'Hz';
           else if (id.includes('ratio')) label.textContent = val + ':1';
           else label.textContent = val;
       }
       updateNodesFromUI();
   });
});
document.querySelectorAll('.toggle-pill').forEach(btn => { if(btn.id !== 'anti-gate-btn') btn.addEventListener('click', () => { setToggle(btn, !isOn(btn)); updateNodesFromUI(); }); });

/* INIT UI */
const pSel = $('preset-sel');
Object.keys(BUILTINS).forEach(k => { const opt = document.createElement('option'); opt.value = k; opt.text = k; pSel.appendChild(opt); });
$('preset-load').onclick = () => { if(BUILTINS[pSel.value]) loadState(BUILTINS[pSel.value]); showToast(`Loaded: ${pSel.value}`); };
initSlots();
$('slot-save').onclick = saveToSlot;
$('slot-rename').onclick = renameSlot;
$('slot-export').onclick = exportSlots;
$('slot-import').onclick = () => $('import-file').click();
$('import-file').onchange = importSlots;
setToggle($('anti-gate-btn'), true);

const resizeCanvas = () => { const c = $('vu-canvas'); const r = c.parentElement.getBoundingClientRect(); c.width = r.width; c.height = r.height; };
window.onresize = resizeCanvas; resizeCanvas();
</script>
</body>
</html>
